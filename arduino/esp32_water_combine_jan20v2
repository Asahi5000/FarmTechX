#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <OneWire.h>
#include <DallasTemperature.h>
#include <EEPROM.h>

// ================= PIN CONFIG =================
#define ONE_WIRE_BUS 17
#define TDS_PIN 34
#define PH_PIN 36
#define TDS_POWER 26
#define CALIB_BUTTON 25
#define PUMP_SSR 18

// ================= WIFI CONFIG =================
const char* ssid = "Abanes_2.4g";
const char* password = "Chijedjoydred20";

// ================= SERVER CONFIG =================
const char* serverName = "http://192.168.1.7/FarmTechX/assets/php/api/save-temp.php";
const char* pumpURL   = "http://192.168.1.7/FarmTechX/assets/php/api/pump-control.php";

// ================= EEPROM =================
#define EEPROM_SIZE 64
float tdsCalibration = 1.138;

// ================= DS18B20 =================
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature DS18B20(&oneWire);

// ================= GLOBAL =================
float temperature, tdsValue, ecValue, phValue;
bool pumpState = false;

#define TDS_SAMPLES 5
#define PH_SAMPLES 20

// ================= PH CALIBRATION =================
// Replace these after buffer calibration
float PH_SLOPE = -5.70;     // example value
float PH_OFFSET = 21.34;   // example value

// ================= WIFI CONNECT =================
void connectWiFi() {
  if (WiFi.status() == WL_CONNECTED) return;

  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);

  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… WiFi Connected!");
    Serial.print("ESP32 IP: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nâŒ WiFi failed, retrying...");
  }
}

// ================= CHECK PUMP =================
void checkPumpControl() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  http.begin(pumpURL);
  int httpCode = http.GET();

  if (httpCode == 200) {
    String payload = http.getString();

    DynamicJsonDocument doc(256);
    if (!deserializeJson(doc, payload)) {
      const char* state = doc["state"];

      if (strcmp(state, "ON") == 0) {
        digitalWrite(PUMP_SSR, LOW);   // Active LOW relay
        pumpState = true;
      } else {
        digitalWrite(PUMP_SSR, HIGH);
        pumpState = false;
      }
    }
  }

  http.end();
}

// ================= SETUP =================
void setup() {
  Serial.begin(115200);

  pinMode(CALIB_BUTTON, INPUT_PULLUP);
  pinMode(TDS_POWER, OUTPUT);
  pinMode(PUMP_SSR, OUTPUT);

  digitalWrite(TDS_POWER, LOW);
  digitalWrite(PUMP_SSR, HIGH);  // Pump OFF on boot

  EEPROM.begin(EEPROM_SIZE);
  EEPROM.get(0, tdsCalibration);
  if (isnan(tdsCalibration) || tdsCalibration <= 0) {
    tdsCalibration = 1.138;
  }

  // ADC configuration
  analogReadResolution(12);
  analogSetAttenuation(ADC_11db);

  connectWiFi();
  DS18B20.begin();
}

// ================= LOOP =================
void loop() {

  connectWiFi();
  checkPumpControl();

  // ---------- TEMPERATURE ----------
  DS18B20.requestTemperatures();
  temperature = DS18B20.getTempCByIndex(0);

  // ---------- TDS / EC ----------
  digitalWrite(TDS_POWER, HIGH);
  delay(500);

  float tdsSum = 0;
  for (int i = 0; i < TDS_SAMPLES; i++) {
    int raw = analogRead(TDS_PIN);
    float voltage = raw * 3.3 / 4095.0;
    float compensation = 1.0 + 0.02 * (temperature - 25.0);
    float compensatedVoltage = voltage / compensation;

    float tds = (133.42 * pow(compensatedVoltage, 3)
               - 255.86 * pow(compensatedVoltage, 2)
               + 857.39 * compensatedVoltage) * 0.5;

    tdsSum += tds;
    delay(50);
  }

  tdsValue = (tdsSum / TDS_SAMPLES) * tdsCalibration;
  ecValue = tdsValue / 500.0;

  digitalWrite(TDS_POWER, LOW);

  // ---------- PH ----------
  delay(500);
  float phSum = 0;

  for (int i = 0; i < PH_SAMPLES; i++) {
    phSum += analogRead(PH_PIN) * 3.3 / 4095.0;
    delay(50);
  }

  float voltageAvg = phSum / PH_SAMPLES;
  phValue = PH_SLOPE * voltageAvg + PH_OFFSET;

  // ---------- SERIAL OUTPUT ----------
  Serial.println("=================================");
  Serial.print("ðŸŒ¡ Temp: "); Serial.print(temperature); Serial.println(" Â°C");
  Serial.print("ðŸ’§ TDS: "); Serial.print(tdsValue); Serial.println(" ppm");
  Serial.print("ðŸŒŠ EC: "); Serial.print(ecValue); Serial.println(" mS/cm");
  Serial.print("ðŸ§ª pH Voltage: "); Serial.println(voltageAvg, 3);
  Serial.print("ðŸ§ª pH Value: "); Serial.println(phValue, 2);
  Serial.print("ðŸš° Pump: "); Serial.println(pumpState ? "ON" : "OFF");
  Serial.println("=================================");

  // ---------- SEND TO SERVER ----------
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(serverName);
    http.addHeader("Content-Type", "application/x-www-form-urlencoded");

    String postData = "temperature=" + String(temperature, 2) +
                      "&tds=" + String(tdsValue, 2) +
                      "&ec=" + String(ecValue, 2) +
                      "&ph=" + String(phValue, 2);

    http.POST(postData);
    http.end();
  }

  delay(1500);
}
